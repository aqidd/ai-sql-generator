<!--
Changes made:
2025-03-16: Created frontend with Vue.js for database connection and schema display
2025-03-16: Added support for connection string and port configuration
2025-03-16: Improved error handling with UI alerts and loading states
2025-03-16: Fixed schema response handling and query generation
2025-03-28: Added sample data display for each table
-->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Schema Viewer</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4589K7P5CK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'G-4589K7P5CK');
    </script>
  </head>
  <body class="bg-gray-50">
    <div id="app" class="container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <!-- Error Alert -->
        <div
          v-if="error"
          class="mb-4 bg-red-50 border-l-4 border-red-500 p-4 relative"
          role="alert"
        >
          <div class="flex items-start">
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Connection Error</h3>
              <div class="mt-1 text-sm text-red-700">{{ error }}</div>
            </div>
            <div class="ml-auto pl-3">
              <div class="-mx-1.5 -my-1.5">
                <button
                  @click="error = ''"
                  class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                >
                  ✕
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Success Alert -->
        <div
          v-if="successMessage"
          class="mb-4 bg-green-50 border-l-4 border-green-500 p-4 relative"
          role="alert"
        >
          <div class="flex items-start">
            <div class="ml-3">
              <h3 class="text-sm font-medium text-green-800">Success</h3>
              <div class="mt-1 text-sm text-green-700">{{ successMessage }}</div>
            </div>
            <div class="ml-auto pl-3">
              <div class="-mx-1.5 -my-1.5">
                <button
                  @click="successMessage = ''"
                  class="inline-flex rounded-md p-1.5 text-green-500 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                >
                  ✕
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Error Alert -->
        <div
          v-if="errorMessage"
          class="mb-4 bg-red-50 border-l-4 border-red-500 p-4 relative"
          role="alert"
        >
          <div class="flex items-start">
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Error</h3>
              <div class="mt-1 text-sm text-red-700">{{ errorMessage }}</div>
            </div>
            <div class="ml-auto pl-3">
              <div class="-mx-1.5 -my-1.5">
                <button
                  @click="errorMessage = ''"
                  class="inline-flex rounded-md p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                >
                  ✕
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Connection Form -->
        <div v-if="!connected" class="bg-white rounded-lg shadow-lg p-6 mb-8">
          <h1 class="text-2xl font-bold mb-6">Database Connection</h1>
          <!-- Connection Type Toggle -->
          <div class="mb-6">
            <div class="flex gap-4 p-1 bg-gray-100 rounded-lg w-fit">
              <button
                @click="connectionType = 'standard'"
                type="button"
                :class="[
                                'px-4 py-2 rounded-md text-sm font-medium transition-colors',
                                connectionType === 'standard' 
                                    ? 'bg-white text-blue-600 shadow'
                                    : 'text-gray-600 hover:text-gray-900'
                            ]"
              >
                Standard
              </button>
              <button
                @click="connectionType = 'connection-string'"
                type="button"
                :class="[
                                'px-4 py-2 rounded-md text-sm font-medium transition-colors',
                                connectionType === 'connection-string' 
                                    ? 'bg-white text-blue-600 shadow'
                                    : 'text-gray-600 hover:text-gray-900'
                            ]"
              >
                Connection String
              </button>
            </div>
          </div>
          <form @submit.prevent="connectToDatabase" class="space-y-4">
            <!-- Standard Connection Form -->
            <div v-if="connectionType === 'standard'" class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Host</label>
                <input
                  v-model="standardConfig.host"
                  type="text"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Port</label>
                <input
                  v-model="standardConfig.port"
                  type="number"
                  placeholder="3306"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Database</label>
                <input
                  v-model="standardConfig.database"
                  type="text"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">Username</label>
                <input
                  v-model="standardConfig.user"
                  type="text"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  required
                />
              </div>
              <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Password</label>
                <input
                  v-model="standardConfig.password"
                  type="password"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  required
                />
              </div>
            </div>
            <!-- Connection String Form -->
            <div v-else class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Connection String</label>
                <input
                  v-model="connectionString"
                  type="text"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm"
                  placeholder="mysql://user:password@localhost:3306/database"
                  required
                />
              </div>
              <p class="text-sm text-gray-500">
                Format: mysql://username:password@host:port/database
              </p>
            </div>
            <div class="flex justify-end gap-4">
              <button
                @click="testWithDummyDB"
                type="button"
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
              >
                Test with Dummy DB
              </button>
              <button
                type="submit"
                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                :disabled="loading"
              >
                <template v-if="loading">
                  <svg
                    class="animate-spin -ml-1 mr-2 h-4 w-4 text-white"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  Connecting...
                </template>
                <template v-else>
                  Connect
                </template>
              </button>
            </div>
          </form>
          <!-- Video Preview -->
          <div class="mt-6">
            <h2 class="text-3xl font-medium text-gray-900 mb-2">How It Works</h2>
            <video controls class="w-full rounded-lg shadow-md">
              <source src="/DB AI Assistant.mp4" type="video/mp4" />
              Your browser does not support the video tag.
            </video>
          </div>
          <!-- Need a customization section -->
          <div class="mt-16">
            <div class="grid md:grid-cols-1 items-center">
              <div class="space-y-6">
                <h3 class="text-2xl font-bold">Need Customization?</h3>
                <p class="text-gray-600">
                  If you have an existing metrics to track or need more complex features than our
                  base offerings, we can help you with that. Ping us at flipboxstudio@gmail.com
                </p>
              </div>
            </div>

            <!-- Feature grid -->
            <div class="grid md:grid-cols-3 gap-4 mt-8">
              <div class="bg-gray-400 p-8 rounded-lg text-white">
                <h4 class="text-xl font-bold mb-4">Custom metrics</h4>
                <p>We'll create new metrics based on your requirement.</p>
              </div>
              <div class="bg-red-400 p-8 rounded-lg text-white">
                <h4 class="text-xl font-bold mb-4">AI customization</h4>
                <p>We can integrate other AI use cases to suit your personalized needs</p>
              </div>
              <div class="bg-blue-400 p-8 rounded-lg text-white">
                <h4 class="text-xl font-bold mb-4">Feature Customization</h4>
                <p>Need another feature? Let us know</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Schema Display and Query Interface -->
        <div v-else class="space-y-6">
          <!-- Query Section -->
          <div class="bg-white rounded-lg shadow-lg p-8 space-y-6">
            <h2 class="text-xl font-semibold text-gray-900">AI Query Assistant</h2>
            <div class="space-y-6">
              <!-- Upload Reference Document -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700"
                  >Upload Reference Document</label
                >
                <input
                  type="file"
                  @change="uploadReferenceDocument"
                  accept=".txt,.pdf,.docx"
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
              </div>
              <!-- Ask a Question -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700"
                  >Ask a question about your data</label
                >
                <textarea
                  v-model="question"
                  class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                  rows="3"
                  placeholder="e.g., 'Show me all users who registered this month' or 'Find the total number of orders by category'"
                ></textarea>
              </div>
              
              <!-- Chart Type Selection -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Visualization Type</label>
                <div class="flex flex-wrap gap-2">
                  <button
                    @click="selectedChartType = null"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === null
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    None
                  </button>
                  
                  <button
                    @click="selectedChartType = 'pie'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'pie'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Pie Chart
                  </button>
                  <button
                    @click="selectedChartType = 'line'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'line'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Line Chart
                  </button>
                  <button
                    @click="selectedChartType = 'bar'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'bar'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Bar Chart
                  </button>
                  <button
                    @click="selectedChartType = 'polarArea'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'polarArea'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Polar Area Chart
                  </button>
                  <button
                    @click="selectedChartType = 'radar'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'radar'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Radar Chart
                  </button>
                  <button
                    @click="selectedChartType = 'scatter'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'scatter'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Scatter Chart
                  </button>
                  <button
                    @click="selectedChartType = 'doughnut'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'doughnut'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Doughnut Chart
                  </button>
                  <button
                    @click="selectedChartType = 'bubble'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'bubble'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Bubble Chart
                  </button>
                  <button
                    @click="selectedChartType = 'mixed'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'mixed'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Mixed Chart
                  </button>
                  <button
                    @click="selectedChartType = 'any'"
                    type="button"
                    :class="[
                      'px-3 py-2 text-sm font-medium rounded-md transition-colors flex items-center gap-1',
                      selectedChartType === 'any'
                        ? 'bg-blue-100 text-blue-700 border border-blue-300'
                        : 'bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200'
                    ]"
                  >
                    Any
                  </button>
                </div>
              </div>
              <!-- Preview Document -->
              <div
                v-if="referenceText"
                class="mt-6 bg-gray-50 border-l-4 border-gray-500 p-4 rounded-md"
              >
                <div class="flex items-start gap-4">
                  <div class="flex-1">
                    <h3 class="text-sm font-medium text-gray-800">Uploaded Document Preview</h3>
                    <pre
                      class="mt-2 text-sm text-gray-700 whitespace-pre-wrap font-mono max-h-40 overflow-y-auto"
                    >
                                        {{ referenceText.slice(0, 50) }}{{ referenceText.length > 50 ? '...' : '' }}
                                    </pre
                    >
                  </div>
                </div>
              </div>
              <!-- Generate Query Button -->
              <div class="flex justify-end">
                <button
                  @click="generateQuery"
                  class="inline-flex items-center px-5 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                  :disabled="!question || queryLoading"
                >
                  <template v-if="queryLoading">
                    <svg
                      class="animate-spin -ml-1 mr-2 h-5 w-5 text-white"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                      ></path>
                    </svg>
                    Generating Query...
                  </template>
                  <template v-else>
                    Generate Query
                  </template>
                </button>
              </div>
            </div>

            <!-- Generated Query Display -->
            <div v-if="generatedQuery" class="space-y-6">
              <div class="rounded-md bg-gray-50 p-6">
                <div class="flex items-start gap-4">
                  <div class="flex-1">
                    <pre class="text-sm text-gray-600 whitespace-pre-wrap font-mono">
{{ generatedQuery.sql }}</pre
                    >
                    <p class="mt-2 text-sm text-gray-500">{{ generatedQuery.explanation }}</p>
                    <div v-if="generatedQuery.isUnsafe" class="mt-2 flex items-center gap-2">
                      <p class="text-sm text-yellow-700">
                        This query contains data-modifying operations (UPDATE/DELETE). Please review
                        carefully.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex justify-end">
                <button
                  @click="executeQuery"
                  class="inline-flex items-center px-5 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed"
                  :disabled="executionLoading"
                >
                  <template v-if="executionLoading">
                    <svg
                      class="animate-spin -ml-1 mr-2 h-5 w-5 text-white"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                    >
                      <circle
                        class="opacity-25"
                        cx="12"
                        cy="12"
                        r="10"
                        stroke="currentColor"
                        stroke-width="4"
                      ></circle>
                      <path
                        class="opacity-75"
                        fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                      ></path>
                    </svg>
                    Executing...
                  </template>
                  <template v-else>
                    Execute Query
                  </template>
                </button>
              </div>
            </div>

            <!-- Query Error with Regeneration -->
            <div
              v-if="queryError"
              class="mt-6 bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-md"
            >
              <div class="flex items-start gap-4">
                <div class="flex-1">
                  <h3 class="text-sm font-medium text-yellow-800">Query Error</h3>
                  <p class="mt-2 text-sm text-yellow-700">{{ queryError }}</p>
                  <div class="mt-4 flex items-center gap-4">
                    <button
                      @click="regenerateQuery"
                      class="inline-flex items-center px-4 py-2 border border-yellow-600 rounded-md text-sm font-medium text-yellow-700 bg-yellow-50 hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 disabled:opacity-50"
                    >
                      Fix and Regenerate Query
                    </button>
                    <button
                      @click="queryError = null"
                      class="text-sm text-yellow-600 hover:text-yellow-800"
                    >
                      Dismiss
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Chart Visualization -->
            <div class="mt-6 bg-white p-6 rounded-lg shadow-lg">
              <h3 class="text-lg font-medium text-gray-900 mb-4">
                Data Visualization
              </h3>
              <div class="h-80 relative">
                <canvas ref="chartCanvas"></canvas>
              </div>
            </div>

            <!-- Query Results -->
            <div v-if="queryResults" class="mt-6">
              <div
                v-if="regeneratedQuery"
                class="mb-6 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-md"
              >
                <div class="flex items-start gap-4">
                  <div>
                    <h3 class="text-sm font-medium text-blue-800">
                      Query Regenerated Successfully
                    </h3>
                    <div class="mt-2 text-sm text-blue-700">
                      <p class="font-medium">New Query:</p>
                      <pre class="mt-2 p-3 bg-blue-100 rounded">{{ regeneratedQuery.sql }}</pre>
                      <p class="mt-4 font-medium">Explanation:</p>
                      <p class="mt-2">{{ regeneratedQuery.explanation }}</p>
                    </div>
                  </div>
                </div>
              </div>
              <h3 class="text-lg font-medium text-gray-900 mb-4">Results</h3>
              <div class="overflow-x-auto">
                <table
                  v-if="Array.isArray(queryResults)"
                  class="min-w-full divide-y divide-gray-200"
                >
                  <thead class="bg-gray-50">
                    <tr>
                      <th
                        v-for="column in Object.keys(queryResults[0] || {})"
                        :key="column"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                      >
                        {{ column }}
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="(row, index) in queryResults" :key="index">
                      <td
                        v-for="column in Object.keys(queryResults[0] || {})"
                        :key="column"
                        class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                      >
                        {{ row[column] }}
                      </td>
                    </tr>
                  </tbody>
                </table>
                <div v-else class="text-sm text-gray-500">
                  {{ JSON.stringify(queryResults, null, 2) }}
                </div>
              </div>
            </div>
          </div>

          <!-- Schema Display -->
          <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">Schema: {{ getDatabaseName() }}</h1>
            <button
              @click="disconnect"
              class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Disconnect
            </button>
          </div>

          <div
            v-for="table in schema"
            :key="table.tableName"
            class="bg-white rounded-lg shadow-lg overflow-hidden mb-6"
          >
            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
              <h3 class="text-lg font-medium text-gray-900">{{ table.tableName }}</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Column
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Type
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Nullable
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Key
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Default
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Extra
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr v-for="column in table.columns" :key="column.name">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {{ column.name }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ column.type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ column.nullable }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ column.key }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ column.default }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ column.extra }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Sample Data Section -->
            <div v-if="table.sampleData" class="px-4 py-3 bg-blue-50 border-t border-blue-200">
              <div class="flex items-center gap-2 mb-2">
                <h4 class="text-sm font-medium text-blue-800">Sample Data</h4>
              </div>
              <div class="overflow-x-auto bg-white rounded-md border border-blue-100">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-blue-50">
                    <tr>
                      <th
                        v-for="(value, key) in table.sampleData"
                        :key="key"
                        class="px-4 py-2 text-left text-xs font-medium text-blue-700 uppercase tracking-wider"
                      >
                        {{ key }}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td
                        v-for="(value, key) in table.sampleData"
                        :key="key"
                        class="px-4 py-2 text-sm text-gray-700 border-t border-gray-100"
                      >
                        {{ value === null ? 'NULL' : value }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div
              v-else
              class="px-4 py-3 bg-gray-100 border-t border-gray-200 text-sm text-gray-500 italic"
            >
              No sample data available for this table
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref } = Vue;

      createApp({
        setup() {
          const connectionType = ref('standard');
          const standardConfig = ref({
            host: '',
            port: 3306,
            user: '',
            password: '',
            database: '',
          });
          const connectionString = ref('');
          const connected = ref(false);
          const schema = ref([]);
          const error = ref('');
          const loading = ref(false);

          // Query generation state
          const question = ref('');
          const queryLoading = ref(false);
          const executionLoading = ref(false);
          const generatedQuery = ref(null);
          const queryResults = ref(null);
          const queryError = ref(null);
          const regeneratedQuery = ref(null);
          const referenceText = ref(localStorage.getItem('referenceText') || '');
          const successMessage = ref(''); // Add success message state
          const errorMessage = ref(''); // Add error message state
          const useDummyDB = ref(false); // Add useDummyDB variable
          const selectedChartType = ref(null); // Chart type selection
          const chartCanvas = ref(null); // Reference to chart canvas
          const chartInstance = ref(null); // Chart.js instance

          const connectToDatabase = async () => {
            error.value = '';
            loading.value = true;
            try {
              const config =
                connectionType.value === 'standard'
                  ? {
                      type: 'standard',
                      ...standardConfig.value,
                    }
                  : {
                      type: 'connection-string',
                      url: connectionString.value,
                    };

              const response = await fetch('/api/schema', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ...config, useDummyDB: useDummyDB.value }), // Include useDummyDB
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to connect');
              }

              const data = await response.json();
              schema.value = data.schema;
              connected.value = true;
            } catch (e) {
              error.value = e.message;
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
              loading.value = false;
            }
          };

          const getDatabaseName = () => {
            if (connectionType.value === 'standard') {
              return standardConfig.value.database;
            }
            try {
              if (!connectionString.value) return '';
              const url = new URL(connectionString.value);
              return url.pathname.slice(1);
            } catch {
              return '';
            }
          };

          const generateQuery = async () => {
            if (!question.value) return;

            queryLoading.value = true;
            error.value = '';
            generatedQuery.value = null;
            queryResults.value = null;

            try {
              const response = await fetch('/api/generate-query', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  schema: schema.value, // This now includes sample data
                  question: question.value,
                  referenceText: referenceText.value || undefined,
                  useDummyDB: useDummyDB.value, // Include useDummyDB
                  chartType: selectedChartType.value,
                }),
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to generate query');
              }

              generatedQuery.value = await response.json();
            } catch (e) {
              error.value = e.message;
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
              queryLoading.value = false;
            }
          };

          const executeQuery = async () => {
            if (!generatedQuery.value) return;

            executionLoading.value = true;
            queryError.value = null;

            try {
              const config =
                connectionType.value === 'standard'
                  ? {
                      type: 'standard',
                      ...standardConfig.value,
                    }
                  : {
                      type: 'connection-string',
                      url: connectionString.value,
                    };
              
              const response = await fetch('/api/execute-query', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  config,
                  query: generatedQuery.value.sql,
                  isUnsafe: generatedQuery.value.isUnsafe,
                  useDummyDB: useDummyDB.value, // Include useDummyDB
                }),
              });

              const data = await response.json();
              if (!data.success) {
                queryError.value = data.error;
                return;
              }

              queryResults.value = data.results;
            } catch (e) {
              queryError.value = e.message;
            } finally {
              executionLoading.value = false;
            }
          };

          const disconnect = () => {
            connected.value = false;
            schema.value = [];
            error.value = '';
            question.value = '';
            generatedQuery.value = null;
            queryResults.value = null;
            // Reset form data
            if (connectionType.value === 'standard') {
              standardConfig.value = {
                host: '',
                port: 3306,
                user: '',
                password: '',
                database: '',
              };
            } else {
              connectionString.value = '';
            }
          };

          const regenerateQuery = async () => {
            if (!question.value || !schema.value.length) return;

            queryLoading.value = true;
            regeneratedQuery.value = null;

            try {
              const response = await fetch('/api/generate-query', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  schema: schema.value, // This now includes sample data
                  question: question.value,
                  referenceText: referenceText.value || undefined,
                  error: queryError.value || undefined,
                  useDummyDB: useDummyDB.value, // Include useDummyDB
                  chartType: selectedChartType.value, // Include chart type
                }),
              });

              const data = await response.json();
              if (!response.ok) {
                throw new Error(data.error || 'Failed to regenerate query');
              }

              generatedQuery.value = data;
              await executeQuery();
            } catch (e) {
              queryError.value = e.message;
            } finally {
              queryLoading.value = false;
            }
          };

          const uploadReferenceDocument = async event => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
              const response = await fetch('/api/upload-document', {
                method: 'POST',
                body: formData,
              });

              if (!response.ok) {
                throw new Error('Failed to upload document');
              }

              const data = await response.json();
              referenceText.value = data.referenceText;
              localStorage.setItem('referenceText', data.referenceText);
              successMessage.value = 'Document uploaded successfully'; // Replace alert
            } catch (error) {
              errorMessage.value = error.message; // Replace alert
            }
          };

          const testWithDummyDB = async () => {
            error.value = '';
            loading.value = true;
            try {
              const response = await fetch('/api/test-dummy-db', {
                method: 'GET',
                headers: {
                  'Content-Type': 'application/json',
                },
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to connect to dummy database');
              }

              const data = await response.json();
              schema.value = data.schema;
              connected.value = true;
              useDummyDB.value = true;
            } catch (e) {
              error.value = e.message;
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } finally {
              loading.value = false;
            }
          };

          // Chart rendering functions
          const getChartIcon = (chartType) => {
            switch (chartType) {
              case 'pie': return 'pie-chart';
              case 'line': return 'line-chart';
              case 'bar': return 'bar-chart';
              default: return 'chart';
            }
          };
          
          const renderChart = (data, chartConfig) => {
            // Destroy previous chart if it exists
            if (chartInstance.value) {
              chartInstance.value.destroy();
            }
            
            if (!chartCanvas.value || !data || data.length === 0) return;
            
            const ctx = chartCanvas.value.getContext('2d');
            const { type } = chartConfig;
            
            let chartData;
            let options;
            
            switch (type) {
              case 'pie':
                chartData = preparePieChartData(data, chartConfig);
                options = {
                  responsive: true, // Ensure chart is responsive
                  maintainAspectRatio: true, // Maintain aspect ratio
                  plugins: {
                    legend: {
                      position: 'right',
                    },
                    tooltip: {
                      callbacks: {
                        label: (context) => ` ${context.label}: ${context.parsed}`
                      }
                    }
                  }
                };
                break;

              case 'line':
                chartData = prepareLineChartData(data, chartConfig);
                options = {
                  responsive: true, // Ensure chart is responsive
                  maintainAspectRatio: true, // Maintain aspect ratio
                  scales: {
                    y: {
                      beginAtZero: true
                    }
                  }
                };
                break;

              case 'bar':
                chartData = prepareBarChartData(data, chartConfig);
                options = {
                  responsive: true, // Ensure chart is responsive
                  maintainAspectRatio: true, // Maintain aspect ratio
                  scales: {
                    x: {
                      stacked: true,
                    },
                    y: {
                      stacked: true,
                      beginAtZero: true
                    }
                  }
                };
                break;

              case 'doughnut':
                chartData = preparePieChartData(data, chartConfig); // Reuse pie chart data preparation
                options = {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'top',
                    },
                  }
                };
                break;

              case 'polarArea':
                chartData = preparePieChartData(data, chartConfig); // Reuse pie chart data preparation
                options = {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: {
                      position: 'right',
                    },
                  }
                };
                break;

              case 'radar':
                chartData = prepareRadarChartData(data, chartConfig);
                options = {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    r: {
                      beginAtZero: true
                    }
                  }
                };
                break;

              case 'scatter':
                chartData = prepareScatterChartData(data, chartConfig);
                options = chartData.options; // Use dynamically generated options
                break;

              // TODO: handle bubble chart errors
              case 'bubble':
                chartData = prepareBubbleChartData(data, chartConfig);
                options = chartData.options; // Use dynamically generated options
                break;

              // TODO: handle mixed chart error
              case 'mixed':
                chartData = prepareMixedChartData(data, chartConfig);
                options = {
                  responsive: true,
                  maintainAspectRatio: false,
                  scales: {
                    y: {
                      beginAtZero: true
                    }
                  }
                };
                break;
            }
            
            chartInstance.value = new Chart(ctx, {
              type,
              data: chartData,
              options
            });
          };
          
          const preparePieChartData = (data, config) => {
            const { labelColumn, valueColumn } = config;
            
            // Generate random colors for each slice
            const generateColors = (count) => {
              const colors = [];
              for (let i = 0; i < count; i++) {
                const hue = (i * 137) % 360; // Use golden ratio for nice color distribution
                colors.push(`hsl(${hue}, 70%, 60%)`);
              }
              return colors;
            };
            
            const labels = data.map(item => item[labelColumn]);
            const values = data.map(item => item[valueColumn]);
            const backgroundColor = generateColors(labels.length);
            
            return {
              labels,
              datasets: [{
                data: values,
                backgroundColor,
                borderWidth: 1
              }]
            };
          };
          
          const prepareLineChartData = (data, config) => {
            const { timeColumn, seriesColumns } = config;
            
            // Sort data by time column if it exists
            if (timeColumn) {
              data.sort((a, b) => new Date(a[timeColumn]) - new Date(b[timeColumn]));
            }
            
            const labels = data.map(item => item[timeColumn]);
            
            // Generate datasets for each series
            console.log(seriesColumns)
            const datasets = seriesColumns.map((column, index) => {
              const hue = (index * 137) % 360;
              return {
                label: column,
                data: data.map(item => item[column]),
                borderColor: `hsl(${hue}, 70%, 60%)`,
                backgroundColor: `hsla(${hue}, 70%, 60%, 0.1)`,
                fill: false,
                tension: 0.4
              };
            });
            
            return {
              labels,
              datasets
            };
          };
          
          const prepareBarChartData = (data, config) => {
            const { categoryColumn, seriesColumns } = config;
            
            const labels = data.map(item => item[categoryColumn]);
            
            // Generate datasets for each series
            const datasets = seriesColumns.map((column, index) => {
              const hue = (index * 137) % 360;
              return {
                label: column,
                data: data.map(item => item[column]),
                backgroundColor: `hsl(${hue}, 70%, 60%)`,
                stack: 'Stack 0'
              };
            });
            
            return {
              labels,
              datasets
            };
          };

          const prepareRadarChartData = (data, config) => {
            const { labelColumn, seriesColumns } = config;
            const labels = data.map(item => item[labelColumn]);
            const datasets = seriesColumns.map((column, index) => {
              const hue = (index * 137) % 360;
              return {
                label: column,
                data: data.map(item => item[column]),
                borderColor: `hsl(${hue}, 70%, 60%)`,
                backgroundColor: `hsla(${hue}, 70%, 60%, 0.2)`,
                fill: true,
              };
            });
            return { labels, datasets };
          };

          const prepareScatterChartData = (data, config) => {
            const xColumn = config['seriesColumns'][0] || 'x_value';
            const yColumn = config['seriesColumns'][1] || 'y_value';

            const datasets = [{
              label: 'Scatter Dataset',
              data: data.map(item => ({ x: item[xColumn], y: item[yColumn] })),
              backgroundColor: 'rgba(75, 192, 192, 1)',
            }];

            const xValues = data.map(item => item[xColumn]).filter(value => typeof value === 'number');
            const yValues = data.map(item => item[yColumn]).filter(value => typeof value === 'number');

            const options = {
              scales: {
                x: {
                  type: 'linear',
                  position: 'bottom',
                  min: Math.min(...xValues),
                  max: Math.max(...xValues),
                },
                y: {
                  min: Math.min(...yValues),
                  max: Math.max(...yValues),
                },
              },
            };

            return { datasets, options };
          };

          const prepareBubbleChartData = (data, config) => {
            const xColumn = config['seriesColumns'][0] || 'x_value';
            const yColumn = config['seriesColumns'][1] || 'y_value';
            const sizeColumn = config['seriesColumns'][2] || 'radius';
            
            const datasets = [{
              label: 'Bubble Dataset',
              data: data.map(item => ({
                x: item[xColumn],
                y: item[yColumn],
                r: item[sizeColumn] || 5, // Default radius if sizeColumn is missing
              })),
              backgroundColor: 'rgba(255, 99, 132, 0.5)',
              borderColor: 'rgba(255, 99, 132, 1)',
            }];

            const xValues = data.map(item => item[xColumn]).filter(value => typeof value === 'number');
            const yValues = data.map(item => item[yColumn]).filter(value => typeof value === 'number');

            const options = {
              scales: {
                x: {
                  type: 'linear',
                  position: 'bottom',
                  min: Math.min(...xValues),
                  max: Math.max(...xValues),
                },
                y: {
                  min: Math.min(...yValues),
                  max: Math.max(...yValues),
                },
              },
            };

            return { datasets, options };
          };

          const prepareMixedChartData = (data, config) => {
            const { datasetsConfig } = config;
            const datasets = datasetsConfig.map((datasetConfig, index) => {
              const hue = (index * 137) % 360;
              return {
                type: datasetConfig.type,
                label: datasetConfig.label,
                data: data.map(item => item[datasetConfig.column]),
                backgroundColor: `hsla(${hue}, 70%, 60%, 0.5)`,
                borderColor: `hsl(${hue}, 70%, 60%)`,
                fill: datasetConfig.type === 'line',
              };
            });
            return { labels: data.map(item => item[datasetsConfig[0].labelColumn]), datasets };
          };

          const watch = Vue.watch;

          // Watch for changes in queryResults and chartConfig to render the chart
          watch(
            () => ({ queryResults: queryResults.value, chartConfig: generatedQuery.value?.chartConfig }),
            ({ queryResults, chartConfig }) => {
              if (queryResults && chartConfig) {
                console.log(queryResults, chartConfig)
                renderChart(queryResults, chartConfig);
              }
            }
          );

          return {
            connectionType,
            standardConfig,
            connectionString,
            connected,
            schema,
            error,
            loading,
            question,
            queryLoading,
            executionLoading,
            generatedQuery,
            queryResults,
            queryError,
            regeneratedQuery,
            referenceText,
            successMessage, // Add success message state
            errorMessage, // Add error message state
            useDummyDB, // Add useDummyDB variable
            selectedChartType,
            chartCanvas,
            getChartIcon,
            connectToDatabase,
            disconnect,
            getDatabaseName,
            generateQuery,
            executeQuery,
            uploadReferenceDocument,
            testWithDummyDB,
            regenerateQuery, // Add regenerateQuery to the returned object
          };
        },
      }).mount('#app');
    </script>
  </body>
</html>
